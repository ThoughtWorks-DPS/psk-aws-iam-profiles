<div align="center">
	<p>
	<img alt="Thoughtworks Logo" src="https://raw.githubusercontent.com/ThoughtWorks-DPS/static/master/thoughtworks_flamingo_wave.png?sanitize=true" width=200 /><br />
	<img alt="DPS Title" src="https://raw.githubusercontent.com/ThoughtWorks-DPS/static/master/EMPCPlatformStarterKitsImage.png?sanitize=true" width=350/><br />
	<h2>psk-aws-iam-profiles</h2>
	<a href="https://opensource.org/licenses/MIT"><img src="https://img.shields.io/github/license/ThoughtWorks-DPS/lab-iam-profiles"></a> <a href="https://aws.amazon.com"><img src="https://img.shields.io/badge/-deployed-blank.svg?style=social&logo=amazon"></a>
	</p>
</div>

## maintainers notes

### architecture  

_main.tf_  

This configuration is only applied in the `state` account and is related to service accounts (machine users) and service account groups.  

EP infrastructure service accounts must be placed within the `/PSKServiceAccounts/` IAM User path in order for service account credentials to be created and/or rotated.  

_Roles_  

By convention, a unique role is created to match each infrastructure pipeline. A separate terrform file is created for each role, named to match the github repository of the pipeline that uses the role.  

EP infrastructure roles must be placed within the `/PSKRoles/` IAM Role path in order for the dependent service account to be able to assume.  

The platform AWS Roles are named generally after the code repository of the pipeline for which they are created and follow a sort of camel case naming convention, but are prefixed with `PSK` and end in `Role`.  

Ex: the role for the psk-aws-iam-profiles pipeline is named `PSKIamProfilesRole`. See the other existing roles for guideance.  

When creating a new role, be sure to create the related inspec test in the iam-roles folder for integration testing.  

_terraform modules_  

Uses the following AWS official terraform modules: (check for updates)  

terraform-aws-modules/iam/aws//modules/iam-user  
terraform-aws-modules/iam/aws//modules/iam-group-with-assumable-roles-policy  
terraform-aws-modules/iam/aws//modules/iam-assumable-role  

_integration tests_  

The post-run integration tests are limited to testing for the existence of the named role, and that the role has the correct named policy attached. We do not check the details of the individual policy statements. This is because such a test would involve duplicating a long list of permission settings (basically the same as defined within the policy) and then comparing that against the same list in the actual declarative policy file. It is the terraform api that is actually making the configuration change so if is succeeds at all that means it has successfully applied what is defined in the policy file. Therefore checking a list of permissions we write ourselves in one file against another list of the same permission we separately type into another file is actually more likely to result in multiple false-postives then simply using the role in the dependent pipeline and adjusting for failures from there.  

_credential rotation_  

Presently, a scheduled pipeline is configured to run once per week. This pipeline will perform a two-key rotation pattern and then run the integration tests. The effect of which is that PSK infrastructure service account credentials are fully rotated every two weeks.  

### local engineering practice additions or notes (See lab-documentation for standard practices and ADRs)  

1. specific .gitignore entries

* Ignore all extensions of .auto.tfvars.json. These are autogenerated during the pipeline run and are ignored so that any local testing doesn't accidently cause problems to the pipeline.  

2. requirements-dev.txt used only for pre-commit local commit hook management

3. additional pre-commit checks. these checks are typically also performed by the pipeline. Multiple tools are used here or demonstration purposes. Some may overlap in whole or part such as check/trivy. Generally it is recommended that you choose one of these tools and then broadly implement.

* terraform fmt
* terraform validate
* [tflint](https://github.com/terraform-linters/tflint)
* [checkov](https://github.com/bridgecrewio/checkov)

### Tools used in this repo or by the pipeline

* [pre-commit](https://pre-commit.com)
* Common [pre-commit-hooks](https://github.com/pre-commit/pre-commit-hooks)
* [pre-commit-terraform](https://github.com/antonbabenko/pre-commit-terraform)
* [awslabs/git-secrets](https://github.com/awslabs/git-secrets)
* Circleci Executor: [twdps/circleci-infra-aws](https://github.com/ThoughtWorks-DPS/circleci-infra-aws)
* [Terraform Cloud](https://app.terraform.io/) for backend state
* [1password](https://1password.com) for secrets
* [awspec(https://github.com/k1LoW/awspec)]
* [iam-credential-rotation](https://github.com/ThoughtWorks-DPS/iam-credential-rotation)
* [orbs](https://circleci.com/developer/orbs): twdps/terraform, twdps/onepassword, twdps/pipeline-events
* [tflint](https://github.com/terraform-linters/tflint)
* [trivy](https://github.com/aquasecurity/trivy)
* [checkov](https://github.com/bridgecrewio/checkov)
